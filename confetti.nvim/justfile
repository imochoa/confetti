# .PHONY: test lint format format-check install-tools help

# Default target
help:
	@echo "Available targets:"
	@echo "  make test          - Run tests using plenary.nvim"
	@echo "  make lint          - Run luacheck linter"
	@echo "  make format        - Format code with stylua"
	@echo "  make format-check  - Check code formatting without modifying files"
	@echo "  make install-tools - Install development dependencies (luacheck, stylua)"
	@echo "  make all           - Run lint, format-check, and test"

# Install development tools
install-tools:
	@echo "Installing luacheck..."
	@command -v luarocks >/dev/null 2>&1 || { echo "luarocks not found. Please install it first."; exit 1; }
	luarocks install --local luacheck
	@echo "Installing stylua..."
	@command -v cargo >/dev/null 2>&1 || { echo "cargo not found. Please install Rust first."; exit 1; }
	cargo install stylua
	@echo "Done! Make sure ~/.luarocks/bin and ~/.cargo/bin are in your PATH"

# Run tests
test:
	@echo "Running tests..."
	@command -v nvim >/dev/null 2>&1 || { echo "neovim not found. Please install it first."; exit 1; }
	@if [ ! -d "/tmp/plenary.nvim" ]; then \
		echo "Cloning plenary.nvim..."; \
		git clone --depth 1 https://github.com/nvim-lua/plenary.nvim /tmp/plenary.nvim; \
	fi
	@export PLENARY_DIR=/tmp/plenary.nvim && \
		nvim --headless --noplugin -u tests/minimal_init.lua -c "PlenaryBustedDirectory tests/ { minimal_init = 'tests/minimal_init.lua' }"

# Run linter
lint:
	@echo "Running luacheck..."
	@command -v luacheck >/dev/null 2>&1 || { echo "luacheck not found. Run 'make install-tools' first."; exit 1; }
	luacheck .

# Format code
format:
	@echo "Formatting code with stylua..."
	@command -v stylua >/dev/null 2>&1 || { echo "stylua not found. Run 'make install-tools' first."; exit 1; }
	stylua .

# Check formatting
format-check:
	@echo "Checking code formatting..."
	@command -v stylua >/dev/null 2>&1 || { echo "stylua not found. Run 'make install-tools' first."; exit 1; }
	stylua --check .

# Run all checks
all: lint format-check test
	@echo "All checks passed!"
